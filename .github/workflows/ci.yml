name: ğŸš€ CI Pipeline - GV Playground

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: playground-eks-cluster
  ECR_REGISTRY: 898307279366.dkr.ecr.us-east-1.amazonaws.com
  ECR_BACKEND_REPO: gv-playground-backend
  ECR_FRONTEND_REPO: gv-playground-frontend

jobs:
  # Lint and Test Backend
  backend-test:
    name: ğŸ§ª Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: ğŸ“¥ Install Dependencies
      run: npm ci
      
    - name: ğŸ” Lint Code
      run: npm run lint
      
    - name: ğŸ§ª Run Tests
      run: npm test
      
    - name: ğŸ—ï¸ Build Application
      run: npm run build
      
    - name: ğŸ“Š Test Coverage
      run: npm run test:coverage
      
    - name: ğŸ“¤ Upload Coverage Reports
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage/lcov.info
        flags: backend
        name: backend-coverage

  # Lint and Test Frontend
  frontend-test:
    name: ğŸ¨ Frontend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¥ Install Dependencies
      run: npm ci
      
    - name: ğŸ” Lint Code
      run: npm run lint
      
    - name: ğŸ§ª Run Tests
      run: npm test
      
    - name: ğŸ—ï¸ Build Application
      run: npm run build
      
    - name: ğŸ“Š Test Coverage
      run: npm run test:coverage
      
    - name: ğŸ“¤ Upload Coverage Reports
      uses: codecov/codecov-action@v3
      with:
        file: ./frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage

  # Security Scanning
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“¤ Upload Trivy Scan Results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # Infrastructure Validation
  infrastructure-test:
    name: ğŸ—ï¸ Infrastructure Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./infrastructure
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
        
    - name: ğŸ”§ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ—ï¸ Terraform Init
      run: terraform init
      
    - name: ğŸ” Terraform Validate
      run: terraform validate
      
    - name: ğŸ“‹ Terraform Plan
      run: terraform plan -var-file="terraform.tfvars"
      
    - name: ğŸ§ª Run Infrastructure Tests
      run: |
        chmod +x ../test-app/test-infrastructure.sh
        ../test-app/test-infrastructure.sh

  # Build and Push Docker Images
  build-and-push:
    name: ğŸ³ Build & Push Images
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ³ Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: ğŸ—ï¸ Build Backend Image
      run: |
        docker build -t $ECR_REGISTRY/$ECR_BACKEND_REPO:$GITHUB_SHA ./backend
        docker tag $ECR_REGISTRY/$ECR_BACKEND_REPO:$GITHUB_SHA $ECR_REGISTRY/$ECR_BACKEND_REPO:latest
        
    - name: ğŸ—ï¸ Build Frontend Image
      run: |
        docker build -t $ECR_REGISTRY/$ECR_FRONTEND_REPO:$GITHUB_SHA ./frontend
        docker tag $ECR_REGISTRY/$ECR_FRONTEND_REPO:$GITHUB_SHA $ECR_REGISTRY/$ECR_FRONTEND_REPO:latest
        
    - name: ğŸ“¤ Push Backend Image
      run: |
        docker push $ECR_REGISTRY/$ECR_BACKEND_REPO:$GITHUB_SHA
        docker push $ECR_REGISTRY/$ECR_BACKEND_REPO:latest
        
    - name: ğŸ“¤ Push Frontend Image
      run: |
        docker push $ECR_REGISTRY/$ECR_FRONTEND_REPO:$GITHUB_SHA
        docker push $ECR_REGISTRY/$ECR_FRONTEND_REPO:latest

  # Deploy to Staging
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-push, infrastructure-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ”§ Configure kubectl
      run: |
        aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME
        
    - name: ğŸš€ Deploy Backend
      run: |
        envsubst < k8s/backend-deployment.yaml | kubectl apply -f -
        
    - name: ğŸš€ Deploy Frontend
      run: |
        envsubst < k8s/frontend-deployment.yaml | kubectl apply -f -
        
    - name: ğŸš€ Deploy Ingress
      run: |
        kubectl apply -f k8s/ingress.yaml
        
    - name: ğŸ” Verify Deployment
      run: |
        kubectl get pods
        kubectl get services
        kubectl get ingress
        
    - name: ğŸ§ª Run Integration Tests
      run: |
        # Wait for pods to be ready
        kubectl wait --for=condition=ready pod -l app=backend --timeout=300s
        kubectl wait --for=condition=ready pod -l app=frontend --timeout=300s
        
        # Test endpoints
        ALB_URL=$(kubectl get ingress playground-ingress -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
        curl -f http://$ALB_URL/api/health || exit 1
        curl -f http://$ALB_URL/ || exit 1

  # Performance Testing
  performance-test:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup K6
      run: |
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
        
    - name: âš¡ Run Performance Tests
      run: |
        # Create a simple K6 test script
        cat > performance-test.js << 'EOF'
        import http from 'k6/http';
        import { check } from 'k6';
        
        export let options = {
          vus: 10,
          duration: '30s',
        };
        
        export default function() {
          let response = http.get('http://playground-alb-415409693.us-east-1.elb.amazonaws.com/api/health');
          check(response, {
            'status is 200': (r) => r.status === 200,
            'response time < 500ms': (r) => r.timings.duration < 500,
          });
        }
        EOF
        
        k6 run performance-test.js

  # Cleanup on Failure
  cleanup-on-failure:
    name: ğŸ§¹ Cleanup on Failure
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: failure()
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ”§ Configure kubectl
      run: |
        aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME
        
    - name: ğŸ§¹ Rollback Deployment
      run: |
        kubectl rollout undo deployment/backend
        kubectl rollout undo deployment/frontend
        
    - name: ğŸ“§ Notify Failure
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()